---
title: "R Notebook"
output: html_notebook
---


```{r, include=F}
knitr::opts_chunk$set(echo = FALSE, warning=F, message=F)
knitr::opts_chunk$set(dev = "png", dev.args = list(type = "cairo-png"))
options(knitr.table.format = "html")
knitr::opts_chunk$set(echo = F)
library(tidyverse)
library(viridis)
library(Replicate)
library(metafor)
library(esc)
library(here)
library(brms)
library(rstan)
library(googledrive)
library(glmnet)
library(tidybayes)
library(ggstance)
library("lattice")
library(reshape2)
library(ggrepel)
library(ggthemes)
library(knitr)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

theme_set(theme_bw())

other_dir <- "../empirica/FYP"

pre <- "data/pre"
post <- "data/post"

```

# Plan

Take text -- spellchecked text in particular and dump it into a csv for this

Run it through gpt thingy

In some order: fix it by hand (to reinclude things that were missing) , and use regexes to cut bad stuff 

wdiff may be our friend for looking at things!

** Will need to figure out what to do about listener -- there's a lot of listener text and it may need a different prompt!!

# Prep
Goal: take raw and pre-gpt it

```{r, include=F}
### study 1
rotate_data_loc <- "data/study1"


one_chat <- read_csv(here(other_dir, rotate_data_loc,"chat.csv")) |> mutate(rotate="rotate")

### study 2a

no_rotate_data_loc <- "data/study2a"

two_a_chat <-  read_csv(here(other_dir, no_rotate_data_loc,"chat.csv")) |> mutate(rotate="no_rotate")

### study 2b

feedback_data_loc <- "data/study2b"

two_b_chat <- read_csv(here(other_dir,feedback_data_loc, "chat.csv")) |> mutate(rotate="full_feedback")

### study 2c
data_location_2c <- "data/study2c"
two_c_chat <- read_csv(here(other_dir,data_location_2c, "chat.csv")) |> mutate(rotate="emoji")

### study 3

data_location_3 <- "data/study3"
three_chat <- read_csv(here(other_dir, data_location_3, "chat.csv")) |> rename(`_id`="X_id",condition=name)
### Combined

  
combined_chat <- one_chat |> 
  rbind(two_a_chat) |> 
  rbind(two_b_chat) |> 
  rbind(two_c_chat) |> 
  mutate(activePlayerCount=NA) |> 
  rename(condition=rotate) |> 
  rbind(three_chat) |> 
  select(gameId, trialNum, repNum, tangram, playerId, role, numPlayers, text, condition, countCorrect, correct, response, activePlayerCount) |>
  write_csv(here(pre, "pre_all.csv"))



```

```{r}

all <- read_csv(here(pre, "pre_all.csv"))

test <- all |> filter(condition=="rotate") |> 
  filter(numPlayers==5) |> 
  filter(repNum==1) |> 
  filter(role=="speaker") |> 
  select(text) |> write_csv(here(pre,"5_1.csv"))
```

# GPT interlude

# Post regex / post-correct
```{r}

fix_thing <- function(text){
  unlist(strsplit(gsub("[\\[\\]']", "", text, perl = TRUE), ", "))
}
normalize <- function(text){
  text |> str_replace_all("hes", "he's") |> 
    str_replace_all("it looks like", "") |> 
    str_replace_all("Kind of looks like", "") |> 
    str_replace_all("Sort of looks like", "") |> 
    str_replace_all("sorry", "") |> 
    str_replace_all("yes", "") |> 
    str_replace_all("Yes", "") |> 
    str_replace_all("Yeah", "") |> 
    str_replace_all("yeah", "") |> 
    str_replace_all("theyre", "they're") |> 
    str_replace_all("dont", "don't") |> 
    str_replace_all("doesnt", "doesn't") |> 
    str_repalce_all("cant", "can't")
}

read_data <- function(file){
 read_csv(here(post, file)) |> 
    mutate(gpt_out = map (gpt_out, .f=fix_thing)) |> 
    unnest(gpt_out) |> 
    group_by(`...1`, text) |> 
    summarize(gpt_out = paste0(gpt_out, collapse = ', ')) |> 
    mutate(gpt_out=normalize(gpt_out))
}


```

```{r}
#foo <- read_data("5_1.csv") |> write_csv("5_1_post.csv")

write_lines(foo$text, "text.txt") 
write_lines(foo$gpt_out, "gpt.txt")

system("wdiff text.txt gpt.txt > foo.txt")

read_lines("foo.txt")|> View()
```

My favorite regex!
(\[-.[^-]*-\])|(\{\+[^\+]*\+\})
